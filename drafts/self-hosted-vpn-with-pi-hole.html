<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <meta name="generator" content="Pelican" />
        <link rel="apple-touch-icon" sizes="180x180" href="https://blog.sebastienbarbier.com/theme/favicon/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="https://blog.sebastienbarbier.com/theme/favicon/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="https://blog.sebastienbarbier.com/theme/favicon/favicon-16x16.png">
        <link rel="manifest" href="https://blog.sebastienbarbier.com/theme/favicon/site.webmanifest">
        <link rel="mask-icon" href="https://blog.sebastienbarbier.com/theme/favicon/safari-pinned-tab.svg" color="#5bbad5">
        <link rel="shortcut icon" href="https://blog.sebastienbarbier.com/theme/favicon/favicon.ico">
        <meta name="msapplication-TileColor" content="#2b5797">
        <meta name="msapplication-config" content="https://blog.sebastienbarbier.com/theme/favicon/browserconfig.xml">
        <meta name="theme-color" content="#ffffff">
        <title>Self hosted VPN with pi-hole</title>
        <link rel="stylesheet" href="https://blog.sebastienbarbier.com/theme/css/main.css" />
        <link href="https://blog.sebastienbarbier.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Blog - Sebastien Barbier Atom Feed" />
        <meta name="description" content="Travelling involve the need to rely on public wifi which can often be insecure. As a VPN offer protection by encrypting all communications, it..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://blog.sebastienbarbier.com/">Blog - Sebastien Barbier</a></h1>
                <nav><ul>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="https://blog.sebastienbarbier.com/drafts/self-hosted-vpn-with-pi-hole.html" rel="bookmark"
           title="Permalink to Self hosted VPN with pi-hole">Self hosted VPN with pi-hole</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2021-08-06T00:00:00+02:00">
                Published: Fri 06 August 2021
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https://blog.sebastienbarbier.com/author/sebastien-barbier/">SÃ©bastien Barbier</a>
        </address>
<p>In <a href="https://blog.sebastienbarbier.com/category/self-hosting/">self-hosting</a>.</p>
<p>tags: <a href="https://blog.sebastienbarbier.com/tag/vpn/">vpn</a> </p>
</footer><!-- /.post-info -->      <p>Travelling involve the need to rely on public wifi which can often be insecure. As a VPN offer protection by encrypting all communications, it however require full trust within its provider. My solution consists of running a self-hosted VPN on a cheap virtual private server. This article is how I did it.</p>
<p><em>Prerequirement: this article assumes basic knowledges in unix commands and docker.</em></p>
<h2>Virtual private server</h2>
<p>First step consists in looking for a provider to host your virtual private server (VPS) on linux. I personnaly went for a <strong>5,52 euros/month</strong> instance at <a href="https://www.ovh.com">OVH</a> (ðŸ‡«ðŸ‡·) with <em>1 vCore, 2 Go RAM, 40 Go SSD NVMe, 250 Mbit/s unlimited</em>. I did successfully use in the past <a href="ttps://www.scaleway.com">scaleway</a>(ðŸ‡«ðŸ‡·) or <a href="https://www.exoscale.com/">exoscale</a> (ðŸ‡¨ðŸ‡­), but would recommand to get a provider near your location for better performance. This will also have an impact on geolocalised content within most website.</p>
<p>VPN can redirect your traffic, but most website will identify your IP as being from a server and often disable some content. For such case I would personnaly use my mobile phone on roaming which provide a direct IP from my home country and so a legitimate way to avoid such issue.</p>
<p>On a last note, please be aware a self hosted server require maintenance and updates to enforce its full security.</p>
<h2>Docker and docker-compose</h2>
<p>Full setup is composed of 4 docker images describe in a single <a href="https://docs.docker.com/compose/">docker-compose</a> file to deploy:</p>
<ul>
<li><strong><a href="https://github.com/kylemanna/docker-openvpn">kylemanna/openvpn</a></strong> for VPN</li>
<li><strong><a href="https://github.com/pi-hole/docker-pi-hole/#running-pi-hole-docker">pihole/pihole:latest</a></strong> for DNS blocking</li>
<li><strong><a href="https://hub.docker.com/_/nginx/">nginx</a></strong> to handle http requests</li>
<li><strong><a href="https://hub.docker.com/r/certbot/certbot">certbot</a></strong> to provide https certificate using lets encrypt</li>
</ul>
<div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span> <span class="s">&#39;3&#39;</span>
<span class="nt">services</span><span class="p">:</span>
  <span class="nt">nginx</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="s">&quot;nginx:latest&quot;</span>
    <span class="nt">ports</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;80:80&quot;</span>
      <span class="p p-Indicator">-</span> <span class="s">&quot;443:443&quot;</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./nginx/:/etc/nginx/conf.d/</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./certbot/conf:/etc/letsencrypt</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./certbot/www:/var/www/certbot</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">/var/log:/var/log</span>
    <span class="nt">links</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">openvpn</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pihole</span>
    <span class="nt">command</span><span class="p">:</span> <span class="s">&quot;/bin/sh</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">&#39;while</span><span class="nv"> </span><span class="s">:;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">6h</span><span class="nv"> </span><span class="s">&amp;</span><span class="nv"> </span><span class="s">wait</span><span class="nv"> </span><span class="s">$${!};</span><span class="nv"> </span><span class="s">nginx</span><span class="nv"> </span><span class="s">-s</span><span class="nv"> </span><span class="s">reload;</span><span class="nv"> </span><span class="s">done</span><span class="nv"> </span><span class="s">&amp;</span><span class="nv"> </span><span class="s">nginx</span><span class="nv"> </span><span class="s">-g</span><span class="nv"> </span><span class="s">\&quot;daemon</span><span class="nv"> </span><span class="s">off;\&quot;&#39;&quot;</span>
  <span class="nt">certbot</span><span class="p">:</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">certbot/certbot</span>
    <span class="nt">volumes</span><span class="p">:</span>  
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./certbot/conf:/etc/letsencrypt</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./certbot/www:/var/www/certbot</span>
    <span class="nt">entrypoint</span><span class="p">:</span> <span class="s">&quot;/bin/sh</span><span class="nv"> </span><span class="s">-c</span><span class="nv"> </span><span class="s">&#39;trap</span><span class="nv"> </span><span class="s">exit</span><span class="nv"> </span><span class="s">TERM;</span><span class="nv"> </span><span class="s">while</span><span class="nv"> </span><span class="s">:;</span><span class="nv"> </span><span class="s">do</span><span class="nv"> </span><span class="s">certbot</span><span class="nv"> </span><span class="s">renew;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">12h</span><span class="nv"> </span><span class="s">&amp;</span><span class="nv"> </span><span class="s">wait</span><span class="nv"> </span><span class="s">$${!};</span><span class="nv"> </span><span class="s">done;&#39;&quot;</span>    
  <span class="nt">openvpn</span><span class="p">:</span>
    <span class="nt">cap_add</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">NET_ADMIN</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kylemanna/openvpn</span>
    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">openvpn</span>
    <span class="nt">ports</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="s">&quot;1194:1194/udp&quot;</span>
    <span class="nt">links</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pihole</span>
    <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">always</span>
    <span class="nt">volumes</span><span class="p">:</span>
     <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">./openvpn-data/conf:/etc/openvpn</span>
  <span class="nt">pihole</span><span class="p">:</span>
    <span class="nt">container_name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pihole</span>
    <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pihole/pihole:latest</span>
    <span class="nt">environment</span><span class="p">:</span>
      <span class="nt">TZ</span><span class="p">:</span> <span class="s">&#39;</span><span class="nv">   </span><span class="s">Europe/Zurich&#39;</span>
      <span class="nt">VIRTUAL_HOST</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pihole.example.com</span>
    <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;./pihole/etc-pihole/:/etc/pihole/&#39;</span>
      <span class="p p-Indicator">-</span> <span class="s">&#39;./pihole/etc-dnsmasq.d/:/etc/dnsmasq.d/&#39;</span>
    <span class="c1"># Recommended but not required (DHCP needs NET_ADMIN)</span>
    <span class="c1">#   https://github.com/pi-hole/docker-pi-hole#note-on-capabilities</span>
    <span class="nt">cap_add</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">NET_ADMIN</span>
    <span class="nt">restart</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>
</pre></div>


<h2>Openvpn</h2>
<p>The <a href="https://github.com/kylemanna/docker-openvpn">kylemanna/docker-openvpn</a> image will run a plug and play openvpn (ovpn) instance on <strong>port 1194</strong>. You will then need to run some configuration. </p>
<p>Initialize the configuration files and certificates</p>
<div class="highlight"><pre><span></span>docker-compose run --rm openvpn ovpn_genconfig -u udp://VPN.SERVERNAME.COM
docker-compose run --rm openvpn ovpn_initpki
</pre></div>


<p>Fix ownership (depending on how to handle your backups, this may not be needed)</p>
<div class="highlight"><pre><span></span>sudo chown -R <span class="k">$(</span>whoami<span class="k">)</span>: ./openvpn-data
</pre></div>


<p>Start OpenVPN server process</p>
<div class="highlight"><pre><span></span>docker-compose up -d openvpn
</pre></div>


<p>You can access the container logs with</p>
<div class="highlight"><pre><span></span>docker-compose logs -f
</pre></div>


<p>Generate a client certificate</p>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CLIENTNAME</span><span class="o">=</span><span class="s2">&quot;your_client_name&quot;</span>
<span class="c1"># with a passphrase (recommended)</span>
docker-compose run --rm openvpn easyrsa build-client-full <span class="nv">$CLIENTNAME</span>
<span class="c1"># without a passphrase (not recommended)</span>
docker-compose run --rm openvpn easyrsa build-client-full <span class="nv">$CLIENTNAME</span> nopass
</pre></div>


<p>Retrieve the client configuration with embedded certificates</p>
<div class="highlight"><pre><span></span>docker-compose run --rm openvpn ovpn_getclient <span class="nv">$CLIENTNAME</span> &gt; <span class="nv">$CLIENTNAME</span>.ovpn
</pre></div>


<p>Revoke a client certificate</p>
<div class="highlight"><pre><span></span><span class="c1"># Keep the corresponding crt, key and req files.</span>
docker-compose run --rm openvpn ovpn_revokeclient <span class="nv">$CLIENTNAME</span>
<span class="c1"># Remove the corresponding crt, key and req files.</span>
docker-compose run --rm openvpn ovpn_revokeclient <span class="nv">$CLIENTNAME</span> remove
</pre></div>


<p>Download the <code>.ovpn</code> file on your machine using <code>scp username@vpn.example.com:my-folder/client-name.ovpn .</code> to connect your VPN using any <a href="https://openvpn.net/vpn-client/">openvpn client</a>.</p>
<h2>Pi-hole</h2>
<p>Pi-hole is a Linux network-level advertisement and Internet tracker blocking application which acts as a DNS sinkhole. It ships as a <a href="https://github.com/pi-hole/docker-pi-hole/#running-pi-hole-docker">docker image</a> and will run next to openvpn.</p>
<p>VPN service is linked to pi-hole so it can call the DNS APIs</p>
<div class="highlight"><pre><span></span><span class="nt">links</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pihole</span>
</pre></div>


<p>Those are the popular lists I ended up using:</p>
<ul>
<li><a href="https://github.com/mhhakim/pihole-blocklist">https://github.com/mhhakim/pihole-blocklist</a></li>
<li><a href="https://avoidthehack.com/best-pihole-blocklists">https://avoidthehack.com/best-pihole-blocklists</a></li>
<li><a href="https://github.com/lightswitch05/hosts">https://github.com/lightswitch05/hosts</a></li>
</ul>
<p>Password can be reset using</p>
<div class="highlight"><pre><span></span>docker <span class="nb">exec</span> -it pihole_container_name pihole -a -p
</pre></div>


<h3>Set default DNS within opvn</h3>
<p>To set default DNS ip within openvpn, you need to know which IP docker assigned to pi-hole:</p>
<div class="highlight"><pre><span></span>docker ps
docker inspect -f <span class="s1">&#39;{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}&#39;</span> pi_hole_container_id
</pre></div>


<p>However, docker will dynamicaly reassign IPs and break static configurations. To avoid such issue, docker-compose needs to define a network description.</p>
<div class="highlight"><pre><span></span><span class="nt">networks</span><span class="p">:</span>
  <span class="nt">myvlan</span><span class="p">:</span>
    <span class="nt">driver</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bridge</span>
    <span class="nt">ipam</span><span class="p">:</span>
     <span class="nt">config</span><span class="p">:</span>
       <span class="p p-Indicator">-</span> <span class="nt">subnet</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.5.0.0/16</span>
         <span class="nt">gateway</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.5.0.1</span>
</pre></div>


<p>Add myvlan as description to all containers</p>
<div class="highlight"><pre><span></span>    <span class="nt">networks</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">myvlan</span>
</pre></div>


<p>Force pihole to use a specific ip address</p>
<div class="highlight"><pre><span></span>    <span class="nt">networks</span><span class="p">:</span>
      <span class="nt">myvlan</span><span class="p">:</span>
        <span class="nt">ipv4_address</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.5.0.6</span>
</pre></div>


<p>Then add within <code>/openvpn-data/confopenvpn.conf</code></p>
<div class="highlight"><pre><span></span><span class="c1"># push &quot;dhcp-option DNS 8.8.8.8&quot;</span>
<span class="c1"># push &quot;dhcp-option DNS 8.8.4.4&quot;</span>
push <span class="s2">&quot;dhcp-option DNS 10.5.0.6&quot;</span>
</pre></div>


<h2>Nginx with https access to pi-hole admin panel</h2>
<p>nginx require a <code>.conf</code> file to expose pi-hole.</p>
<div class="highlight"><pre><span></span>server <span class="o">{</span>
    listen <span class="m">80</span><span class="p">;</span>
    server_name dns.example.com<span class="p">;</span>

    location /.well-known/acme-challenge/ <span class="o">{</span>
        root /var/www/certbot<span class="p">;</span>
    <span class="o">}</span>

    location / <span class="o">{</span>
        <span class="k">return</span> <span class="m">301</span> https://<span class="nv">$host$request_uri</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="c1"># # https://medium.com/@pentacent/nginx-and-lets-encrypt-with-docker-in-less-than-5-minutes-b4b8a60d3a71</span>
server <span class="o">{</span>
    listen <span class="m">443</span> ssl http2<span class="p">;</span>
    server_name dns.example.com<span class="p">;</span>
    try_files <span class="nv">$uri</span>/ <span class="nv">$uri</span><span class="p">;</span>

    ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem<span class="p">;</span>
    ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem<span class="p">;</span>

    include /etc/letsencrypt/options-ssl-nginx.conf<span class="p">;</span>
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem<span class="p">;</span>

    location /.well-known/acme-challenge/ <span class="o">{</span>
        root /var/www/certbot<span class="p">;</span>
    <span class="o">}</span>

    location / <span class="o">{</span>
        proxy_set_header   X-Real-IP        <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header   X-Forwarded-For  <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header   Host             <span class="nv">$host</span><span class="p">;</span>
        proxy_pass http://pihole:80/<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3>Generate SSL certificates</h3>
<p><a href="https://github.com/studentenhuisDS4/ds4reboot/wiki/Docker-and-production-info">studentenhuisDS4/ds4reboot</a> provide a script to generate certificates. </p>
<p>It will first generate <strong>self certified certificates</strong> to enable nginx with 443 port open, then have <strong>letsencrypt challenge</strong> running to validate certificates. It will automatically start nginx using docker-compose without further action required.</p>
<div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="k">if</span> ! <span class="o">[</span> -x <span class="s2">&quot;</span><span class="k">$(</span><span class="nb">command</span> -v docker-compose<span class="k">)</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s1">&#39;Error: docker-compose is not installed.&#39;</span> &gt;<span class="p">&amp;</span><span class="m">2</span>
  <span class="nb">exit</span> <span class="m">1</span>
<span class="k">fi</span>

<span class="nv">domains</span><span class="o">=(</span>my-domain-1.com my-domain-2.com<span class="o">)</span>
<span class="nv">rsa_key_size</span><span class="o">=</span><span class="m">4096</span>
<span class="nv">data_path</span><span class="o">=</span><span class="s2">&quot;./certbot&quot;</span>
<span class="nv">email</span><span class="o">=</span><span class="s2">&quot;admin@example.com&quot;</span> <span class="c1"># Adding a valid address is strongly recommended</span>
<span class="nv">staging</span><span class="o">=</span><span class="m">0</span> <span class="c1"># Set to 1 if you&#39;re testing your setup to avoid hitting request limits</span>

<span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;</span><span class="nv">$data_path</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">read</span> -p <span class="s2">&quot;Existing data found for </span><span class="nv">$domains</span><span class="s2">. Continue and replace existing certificate? (y/N) &quot;</span> decision
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$decision</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;Y&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$decision</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;y&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">exit</span>
  <span class="k">fi</span>
<span class="k">fi</span>


<span class="k">if</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$data_path</span><span class="s2">/conf/options-ssl-nginx.conf&quot;</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> ! -e <span class="s2">&quot;</span><span class="nv">$data_path</span><span class="s2">/conf/ssl-dhparams.pem&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;### Downloading recommended TLS parameters ...&quot;</span>
  mkdir -p <span class="s2">&quot;</span><span class="nv">$data_path</span><span class="s2">/conf&quot;</span>
  curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot-nginx/certbot_nginx/_internal/tls_configs/options-ssl-nginx.conf &gt; <span class="s2">&quot;</span><span class="nv">$data_path</span><span class="s2">/conf/options-ssl-nginx.conf&quot;</span>
  curl -s https://raw.githubusercontent.com/certbot/certbot/master/certbot/certbot/ssl-dhparams.pem &gt; <span class="s2">&quot;</span><span class="nv">$data_path</span><span class="s2">/conf/ssl-dhparams.pem&quot;</span>
  <span class="nb">echo</span>
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">&quot;### Creating dummy certificate for </span><span class="nv">$domains</span><span class="s2"> ...&quot;</span>
<span class="nv">path</span><span class="o">=</span><span class="s2">&quot;/etc/letsencrypt/live/</span><span class="nv">$domains</span><span class="s2">&quot;</span>
mkdir -p <span class="s2">&quot;</span><span class="nv">$data_path</span><span class="s2">/conf/live/</span><span class="nv">$domains</span><span class="s2">&quot;</span>
docker-compose run --rm --entrypoint <span class="s2">&quot;\</span>
<span class="s2">  openssl req -x509 -nodes -newkey rsa:2048 -days 1\</span>
<span class="s2">    -keyout &#39;</span><span class="nv">$path</span><span class="s2">/privkey.pem&#39; \</span>
<span class="s2">    -out &#39;</span><span class="nv">$path</span><span class="s2">/fullchain.pem&#39; \</span>
<span class="s2">    -subj &#39;/CN=localhost&#39;&quot;</span> certbot
<span class="nb">echo</span>


<span class="nb">echo</span> <span class="s2">&quot;### Starting nginx ...&quot;</span>
docker-compose up --force-recreate -d nginx
<span class="nb">echo</span>

<span class="nb">echo</span> <span class="s2">&quot;### Deleting dummy certificate for </span><span class="nv">$domains</span><span class="s2"> ...&quot;</span>
docker-compose run --rm --entrypoint <span class="s2">&quot;\</span>
<span class="s2">  rm -Rf /etc/letsencrypt/live/</span><span class="nv">$domains</span><span class="s2"> &amp;&amp; \</span>
<span class="s2">  rm -Rf /etc/letsencrypt/archive/</span><span class="nv">$domains</span><span class="s2"> &amp;&amp; \</span>
<span class="s2">  rm -Rf /etc/letsencrypt/renewal/</span><span class="nv">$domains</span><span class="s2">.conf&quot;</span> certbot
<span class="nb">echo</span>


<span class="nb">echo</span> <span class="s2">&quot;### Requesting Let&#39;s Encrypt certificate for </span><span class="nv">$domains</span><span class="s2"> ...&quot;</span>
<span class="c1">#Join $domains to -d args</span>
<span class="nv">domain_args</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">for</span> domain <span class="k">in</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">domains</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">do</span>
  <span class="nv">domain_args</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$domain_args</span><span class="s2"> -d </span><span class="nv">$domain</span><span class="s2">&quot;</span>
<span class="k">done</span>

<span class="c1"># Select appropriate email arg</span>
<span class="k">case</span> <span class="s2">&quot;</span><span class="nv">$email</span><span class="s2">&quot;</span> <span class="k">in</span>
  <span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="nv">email_arg</span><span class="o">=</span><span class="s2">&quot;--register-unsafely-without-email&quot;</span> <span class="p">;;</span>
  *<span class="o">)</span> <span class="nv">email_arg</span><span class="o">=</span><span class="s2">&quot;--email </span><span class="nv">$email</span><span class="s2">&quot;</span> <span class="p">;;</span>
<span class="k">esac</span>

<span class="c1"># Enable staging mode if needed</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$staging</span> !<span class="o">=</span> <span class="s2">&quot;0&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span> <span class="nv">staging_arg</span><span class="o">=</span><span class="s2">&quot;--staging&quot;</span><span class="p">;</span> <span class="k">fi</span>

docker-compose run --rm --entrypoint <span class="s2">&quot;\</span>
<span class="s2">  certbot certonly --webroot -w /var/www/certbot \</span>
<span class="s2">    </span><span class="nv">$staging_arg</span><span class="s2"> \</span>
<span class="s2">    </span><span class="nv">$email_arg</span><span class="s2"> \</span>
<span class="s2">    </span><span class="nv">$domain_args</span><span class="s2"> \</span>
<span class="s2">    --rsa-key-size </span><span class="nv">$rsa_key_size</span><span class="s2"> \</span>
<span class="s2">    --agree-tos \</span>
<span class="s2">    --force-renewal&quot;</span> certbot
<span class="nb">echo</span>

<span class="nb">echo</span> <span class="s2">&quot;### Reloading nginx ...&quot;</span>
docker-compose <span class="nb">exec</span> nginx nginx -s reload
</pre></div>


<h2>and more ...</h2>
<p>My personnal setup is currently save within a github repo publicly available at <a href="https://github.com/sebastienbarbier/config-proxy">https://github.com/sebastienbarbier/config-proxy</a></p>
<p>You should now be able to redirect all your traffic through your VPN, and configure pi-hole over https to block unexpected DNS requests.</p>
<p>Best part of such infrastructure is the fact it allowed me to connect my NAS direclty to the VPN so I could access it from anywhere without configuring my router.</p>
<p>Hope this was helpful, thanks for reading.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="https://sebastienbarbier.com/">sebastienbarbier.com</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https://blog.sebastienbarbier.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://www.twitter.com/SebBarbier">Twitter</a></li>
                            <li><a href="https://www.instagram.com/sebastienbarbier/">Instagram</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
        </footer><!-- /#contentinfo -->

</body>
</html>